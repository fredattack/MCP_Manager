name: Deploy to DigitalOcean

on:
  push:
    branches:
      - main
  workflow_dispatch: # Permet le dÃ©clenchement manuel

concurrency:
  group: production-deployment
  cancel-in-progress: false # Ne pas annuler un dÃ©ploiement en cours

jobs:
  # test:
  #   name: Run Tests
  #   runs-on: ubuntu-latest

  #   services:
  #     postgres:
  #       image: postgres:16
  #       env:
  #         POSTGRES_DB: mc-manager-db-testing
  #         POSTGRES_USER: fred
  #         POSTGRES_PASSWORD: secret
  #       options: >-
  #         --health-cmd pg_isready
  #         --health-interval 10s
  #         --health-timeout 5s
  #         --health-retries 5
  #       ports:
  #         - 5432:5432

  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4

  #     - name: Setup PHP
  #       uses: shivammathur/setup-php@v2
  #       with:
  #         php-version: '8.4'
  #         extensions: mbstring, xml, ctype, iconv, intl, pdo_pgsql, pgsql, dom, filter, gd, json, bcmath, zip
  #         coverage: none

  #     - name: Install Composer Dependencies
  #       run: composer install --no-interaction --prefer-dist --optimize-autoloader

  #     - name: Copy .env
  #       run: |
  #         cp .env.example .env
  #         php artisan key:generate

  #     - name: Setup Node.js
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version: '20'
  #         cache: 'npm'

  #     - name: Install NPM Dependencies
  #       run: npm ci

  #     - name: Run PHP Tests
  #       run: php artisan test

  #     - name: Run Pint (Code Style)
  #       run: ./vendor/bin/pint --test

  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    # needs: test  # Temporarily disabled
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install NPM Dependencies
        run: npm ci --ignore-scripts

      - name: Build Frontend Assets
        run: npm run build

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

          # Configure SSH to keep connection alive during long builds
          echo "Host *" >> ~/.ssh/config
          echo "  ServerAliveInterval 60" >> ~/.ssh/config
          echo "  ServerAliveCountMax 120" >> ~/.ssh/config
          echo "  TCPKeepAlive yes" >> ~/.ssh/config

      - name: Copy Built Assets to Server
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
        run: |
          # Copy built assets to server
          scp -i ~/.ssh/deploy_key -P ${SSH_PORT} -r public/build ${SSH_USER}@${SSH_HOST}:/var/www/mcp-manager/public/

      - name: Deploy to Droplet
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
          APP_ENV: ${{ secrets.APP_ENV || 'production' }}
          APP_DEBUG: ${{ secrets.APP_DEBUG || 'false' }}
          APP_URL: ${{ secrets.APP_URL }}
          DB_HOST: ${{ secrets.DB_HOST || '127.0.0.1' }}
          DB_PORT: ${{ secrets.DB_PORT || '5432' }}
          DB_DATABASE: ${{ secrets.DB_DATABASE }}
          DB_USERNAME: ${{ secrets.DB_USERNAME }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        run: |
          ssh -i ~/.ssh/deploy_key -p ${SSH_PORT} ${SSH_USER}@${SSH_HOST} \
            "APP_ENV='${APP_ENV}' \
             APP_DEBUG='${APP_DEBUG}' \
             APP_URL='${APP_URL}' \
             DB_HOST='${DB_HOST}' \
             DB_PORT='${DB_PORT}' \
             DB_DATABASE='${DB_DATABASE}' \
             DB_USERNAME='${DB_USERNAME}' \
             DB_PASSWORD='${DB_PASSWORD}' \
             bash -s" << 'ENDSSH'
            set -e

            echo "ðŸš€ Starting deployment..."

            # Navigate to project directory
            cd /var/www/mcp-manager

            # Enable maintenance mode
            php artisan down --message="Deployment in progress..." --retry=60 || true

            # Pull latest changes
            echo "ðŸ“¥ Pulling latest changes from main..."
            git fetch origin main
            git reset --hard origin/main

            # Configure environment variables
            echo "âš™ï¸ Configuring environment..."

            # Preserve existing APP_KEY if it exists
            EXISTING_APP_KEY=""
            if [ -f .env ] && grep -q "APP_KEY=base64:" .env; then
              EXISTING_APP_KEY=$(grep "APP_KEY=" .env | cut -d '=' -f2-)
            fi

            # Create .env from example
            cp .env.example .env

            # Update critical production values
            sed -i "s|APP_ENV=.*|APP_ENV=${APP_ENV}|" .env
            sed -i "s|APP_DEBUG=.*|APP_DEBUG=${APP_DEBUG}|" .env
            sed -i "s|APP_URL=.*|APP_URL=${APP_URL}|" .env
            sed -i "s|DB_CONNECTION=.*|DB_CONNECTION=pgsql|" .env

            # Add PostgreSQL configuration (uncomment and set values)
            # DB_HOST defaults to 127.0.0.1 since Docker exposes PostgreSQL on localhost
            sed -i "s|^# DB_HOST=.*|DB_HOST=127.0.0.1|" .env
            sed -i "s|^# DB_PORT=.*|DB_PORT=5432|" .env
            sed -i "s|^# DB_DATABASE=.*|DB_DATABASE=${DB_DATABASE}|" .env
            sed -i "s|^# DB_USERNAME=.*|DB_USERNAME=${DB_USERNAME}|" .env
            sed -i "s|^# DB_PASSWORD=.*|DB_PASSWORD=${DB_PASSWORD}|" .env

            # Restore or generate APP_KEY
            if [ -n "$EXISTING_APP_KEY" ]; then
              echo "ðŸ”‘ Restoring existing application key..."
              # Use grep -v to remove old APP_KEY line, then append new one
              grep -v "^APP_KEY=" .env > .env.tmp
              echo "APP_KEY=${EXISTING_APP_KEY}" >> .env.tmp
              mv .env.tmp .env
            else
              echo "ðŸ”‘ Generating new application key..."
              php artisan key:generate --force
            fi

            # Start Docker services (PostgreSQL + Redis)
            echo "ðŸ³ Starting Docker services..."

            # Create .env.docker for Docker Compose
            echo "DB_DATABASE=${DB_DATABASE}" > .env.docker
            echo "DB_USERNAME=${DB_USERNAME}" >> .env.docker
            echo "DB_PASSWORD=${DB_PASSWORD}" >> .env.docker

            # Start containers (detached mode)
            docker compose -f docker-compose.prod.yml --env-file .env.docker up -d

            # Wait for PostgreSQL to be ready
            echo "â³ Waiting for PostgreSQL to be ready..."
            until docker exec mcp-manager-postgres pg_isready -U ${DB_USERNAME} > /dev/null 2>&1; do
              echo "   Waiting for database..."
              sleep 2
            done
            echo "âœ… PostgreSQL is ready!"

            # Install/Update Composer dependencies
            echo "ðŸ“¦ Installing Composer dependencies (this may take 1-2 minutes)..."
            composer install --no-interaction --prefer-dist --optimize-autoloader --no-dev --no-scripts --verbose

            # Note: Frontend assets are built in GitHub Actions and copied via SCP
            # No need to build on the server anymore

            # Run database migrations
            echo "ðŸ—„ï¸  Running database migrations..."
            php artisan migrate --force
            echo "âœ… Migrations completed"

            # Clear and cache configuration
            echo "ðŸ§¹ Clearing and optimizing caches..."
            php artisan config:clear
            echo "  âœ“ Config cache cleared"
            php artisan config:cache
            echo "  âœ“ Config cached"
            php artisan route:cache
            echo "  âœ“ Routes cached"
            php artisan view:cache
            echo "  âœ“ Views cached"
            php artisan event:cache
            echo "  âœ“ Events cached"

            # Optimize application
            echo "âš¡ Optimizing application..."
            php artisan optimize
            echo "âœ… Optimization completed"

            # Set proper permissions
            echo "ðŸ” Setting permissions..."
            chown -R deploy:www-data /var/www/mcp-manager
            chmod -R 775 storage bootstrap/cache

            # Restart services
            echo "ðŸ”„ Restarting services..."
            sudo systemctl reload php8.2-fpm
            sudo supervisorctl restart all

            # Disable maintenance mode
            php artisan up

            echo "âœ… Deployment completed successfully!"

            # Display application version
            php artisan --version
          ENDSSH

      - name: Health Check
        run: |
          sleep 5
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.SSH_HOST }}/health)
          if [ "$RESPONSE" -eq 200 ]; then
            echo "âœ… Health check passed (HTTP $RESPONSE)"
          else
            echo "âŒ Health check failed (HTTP $RESPONSE)"
            exit 1
          fi

      - name: Send Deployment Notification
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            STATUS_EMOJI="âœ…"
            STATUS_TEXT="succeeded"
          else
            STATUS_EMOJI="âŒ"
            STATUS_TEXT="failed"
          fi

          echo "$STATUS_EMOJI Deployment $STATUS_TEXT for commit ${{ github.sha }}"
          # Ajouter ici l'intÃ©gration Slack/Discord si besoin

  rollback:
    name: Rollback Deployment
    runs-on: ubuntu-latest
    needs: deploy
    if: failure()

    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Rollback to Previous Version
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
        run: |
          ssh -i ~/.ssh/deploy_key -p ${SSH_PORT} ${SSH_USER}@${SSH_HOST} << 'ENDSSH'
            cd /var/www/mcp-manager

            echo "âª Rolling back to previous commit..."
            git reset --hard HEAD~1

            composer install --no-interaction --no-dev
            npm ci --production
            npm run build

            php artisan migrate:rollback --force
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache

            sudo systemctl reload php8.2-fpm
            sudo supervisorctl restart all

            php artisan up

            echo "âª Rollback completed"
          ENDSSH